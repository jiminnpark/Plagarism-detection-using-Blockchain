from web3 import Web3 
import json
from chunk_hash import give_chunk_hash
import time


def check_validation(filename,sender):

	##############################
    ganache_url="http://127.0.0.1:7545"
    address='0x52c31eD7410D7Cae39c399EC45903A6Ba3C076eE'
    bytecode='608060405234801561001057600080fd5b506108d8806100206000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c80631f6938da146100515780633e630bfe14610081578063b15497221461009f578063ceef801f146100cf575b600080fd5b61006b600480360381019061006691906104c7565b6100ff565b6040516100789190610529565b60405180910390f35b61008961012d565b6040516100969190610529565b60405180910390f35b6100b960048036038101906100b4919061062a565b610133565b6040516100c6919061068e565b60405180910390f35b6100e960048036038101906100e4919061062a565b6102ab565b6040516100f69190610529565b60405180910390f35b6001818051602081018201805184825260208301602085012081835280955050505050506000915090505481565b60005481565b6000808290506000610144846102ab565b9050601481101561024e5760008251905060005b818110156101f05760006001858381518110610177576101766106a9565b5b602002602001015160405161018c9190610749565b908152602001604051809103902054036101dd576101c58682815181106101b6576101b56106a9565b5b60200260200101516001610346565b6000808154809291906101d79061078f565b91905055505b80806101e89061078f565b915050610158565b503373ffffffffffffffffffffffffffffffffffffffff167fd8b3757af081879c85b11fc0676c4d10be4c1434bdbdc4aa0a587b94737aa07360018460405161023a9291906107d7565b60405180910390a2600193505050506102a6565b3373ffffffffffffffffffffffffffffffffffffffff167fd8b3757af081879c85b11fc0676c4d10be4c1434bdbdc4aa0a587b94737aa0736000836040516102979291906107d7565b60405180910390a26000925050505b919050565b6000806000905060008351905060005b81811015610324576001808683815181106102d9576102d86106a9565b5b60200260200101516040516102ee9190610749565b9081526020016040518091039020540361031157828061030d9061078f565b9350505b808061031c9061078f565b9150506102bb565b50806064836103339190610800565b61033d9190610871565b92505050919050565b806001836040516103579190610749565b9081526020016040518091039020819055505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6103d48261038b565b810181811067ffffffffffffffff821117156103f3576103f261039c565b5b80604052505050565b600061040661036d565b905061041282826103cb565b919050565b600067ffffffffffffffff8211156104325761043161039c565b5b61043b8261038b565b9050602081019050919050565b82818337600083830152505050565b600061046a61046584610417565b6103fc565b90508281526020810184848401111561048657610485610386565b5b610491848285610448565b509392505050565b600082601f8301126104ae576104ad610381565b5b81356104be848260208601610457565b91505092915050565b6000602082840312156104dd576104dc610377565b5b600082013567ffffffffffffffff8111156104fb576104fa61037c565b5b61050784828501610499565b91505092915050565b6000819050919050565b61052381610510565b82525050565b600060208201905061053e600083018461051a565b92915050565b600067ffffffffffffffff82111561055f5761055e61039c565b5b602082029050602081019050919050565b600080fd5b600061058861058384610544565b6103fc565b905080838252602082019050602084028301858111156105ab576105aa610570565b5b835b818110156105f257803567ffffffffffffffff8111156105d0576105cf610381565b5b8086016105dd8982610499565b855260208501945050506020810190506105ad565b5050509392505050565b600082601f83011261061157610610610381565b5b8135610621848260208601610575565b91505092915050565b6000602082840312156106405761063f610377565b5b600082013567ffffffffffffffff81111561065e5761065d61037c565b5b61066a848285016105fc565b91505092915050565b60008115159050919050565b61068881610673565b82525050565b60006020820190506106a3600083018461067f565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600081519050919050565b600081905092915050565b60005b8381101561070c5780820151818401526020810190506106f1565b60008484015250505050565b6000610723826106d8565b61072d81856106e3565b935061073d8185602086016106ee565b80840191505092915050565b60006107558284610718565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061079a82610510565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036107cc576107cb610760565b5b600182019050919050565b60006040820190506107ec600083018561067f565b6107f9602083018461051a565b9392505050565b600061080b82610510565b915061081683610510565b925082820261082481610510565b9150828204841483151761083b5761083a610760565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061087c82610510565b915061088783610510565b92508261089757610896610842565b5b82820490509291505056fea26469706673582212209ed67108fe3e43c655a22b1fe2bdfc8d2ad53d95372edac51df3970bf9fa140b64736f6c63430008120033'
    abi=json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"bool","name":"isValid","type":"bool"},{"indexed":false,"internalType":"uint256","name":"plag_percent","type":"uint256"}],"name":"validation","type":"event"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"chunks","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string[]","name":"_contentHash","type":"string[]"}],"name":"plagarism","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalChunks","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string[]","name":"_contentHash","type":"string[]"}],"name":"validate","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]')
    web3=Web3(Web3.HTTPProvider(ganache_url))
    contract=web3.eth.contract(address=address,abi=abi,bytecode=bytecode)
    ##############################


    # sender='0x00bc367F685a3332f6959FE2FdF5d5634867D3BB'

    print(web3.is_connected())

    hashes=give_chunk_hash(filename)  # logic
    # hashes=['a','b','c']

    bl1=web3.eth.get_balance(sender)
    bl1=(web3.from_wei(bl1,'ether'))

    tx=(contract.functions.validate(hashes).transact({'from':sender}))
    receipt = web3.eth.get_transaction_receipt(tx)
    logs = contract.events.validation().process_receipt(receipt)
    
    isvalid=(logs[0]['args']['isValid'])
    plag_percent=(logs[0]['args']['plag_percent'])
    # plag_list=(logs[0])['args']['plag_list']
    plag_list=[1,4,6,7,8,9,10,12]

    bl2=web3.eth.get_balance(sender)
    bl2=(web3.from_wei(bl2,'ether'))
    

    if isvalid==True:
        	return [bl2,isvalid,plag_percent,plag_list]
    else:
    	return [bl2,plag_percent,plag_list]

